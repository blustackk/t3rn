#!/bin/bash

# Menampilkan ASCII Art untuk "Blustack"
echo "
  _     _           _             _    
 | |   | |         | |           | |   
 | |__ | |_   _ ___| |_ __ _  ___| | __
 | '_ \| | | | / __| __/ _` |/ __| |/ / 
 | |_) | | |_| \__ \ || (_| | (__|   < 
 |_.__/|_|\__,_|___/\__\__,_|\___|_|\_\
"

# Prompt untuk user (default: root)
read -p "Masukkan nama user untuk menjalankan executor (default: root): " EXECUTOR_USER
EXECUTOR_USER=${EXECUTOR_USER:-root}

# Menghentikan dan menghapus service lama jika ada
if systemctl list-units --full -all | grep -q "t3rn-executor.service"; then
    sudo systemctl stop t3rn-executor.service
    sudo systemctl disable t3rn-executor.service
    sudo systemctl daemon-reload
fi

# Menghapus file lama
sudo rm -rf /home/$EXECUTOR_USER/t3rn
sudo rm -rf /etc/systemd/system/t3rn-executor.service
sudo rm -rf /etc/t3rn-executor.env

# Prompt untuk Private Key
while [[ -z "$PRIVATE_KEY_LOCAL" ]]; do
    read -sp "Masukkan PRIVATE_KEY_LOCAL (tidak boleh kosong): " PRIVATE_KEY_LOCAL
    echo ""
done

# Prompt Alchemy API
while [[ -z "$APIKEY_ALCHEMY" ]]; do
    read -p "API Key Alchemy (tidak boleh kosong): " APIKEY_ALCHEMY
    echo
done

# Prompt Gas Price
while [[ -z "$GAS_PRICE" ]]; do
    read -p "Gas Price (tidak boleh kosong): " GAS_PRICE
    echo
done

INSTALL_DIR="/home/$EXECUTOR_USER/t3rn"
SERVICE_FILE="/etc/systemd/system/t3rn-executor.service"
ENV_FILE="/etc/t3rn-executor.env"
EXECUTOR_VERSION="v0.62.0"
EXECUTOR_FILE="executor-linux-$EXECUTOR_VERSION.tar.gz"
EXECUTOR_URL="https://github.com/t3rn/executor-release/releases/download/$EXECUTOR_VERSION/$EXECUTOR_FILE"

# Pastikan direktori ada
mkdir -p "$INSTALL_DIR" && cd "$INSTALL_DIR"

# Cek koneksi sebelum mengunduh
if curl --output /dev/null --silent --head --fail "$EXECUTOR_URL"; then
    echo "🔽 Mengunduh Executor dari $EXECUTOR_URL..."
    curl -L -o "$EXECUTOR_FILE" "$EXECUTOR_URL"
else
    echo "❌ URL tidak dapat diakses, pastikan koneksi internet stabil."
    exit 1
fi

# Ekstrak file
echo "📦 Mengekstrak Executor..."
tar -xzvf "$EXECUTOR_FILE" || {
    echo "❌ Gagal mengekstrak file. Pastikan format file benar."
    exit 1
}

# Bersihkan file unduhan
rm -f "$EXECUTOR_FILE"

# Pastikan direktori yang diperlukan ada sebelum masuk
if [ -d "executor/executor/bin" ]; then
    cd executor/executor/bin || exit 1
    echo "✅ Executor berhasil diunduh dan diekstrak."
else
    echo "❌ Direktori 'executor/executor/bin' tidak ditemukan! Ekstraksi mungkin gagal."
    exit 1
fi

# Konfigurasi environment file
sudo tee $ENV_FILE > /dev/null <<'EOL'
RPC_ENDPOINTS='{
  "l2rn": ["https://t3rn-b2n.blockpi.network/v1/rpc/public", "http://b2n.rpc.caldera.xyz/http"],
  "mont": ["https://testnet-rpc.monad.xyz"],
  "arbt": ["https://arbitrum-sepolia.drpc.org", "https://arb-sepolia.g.alchemy.com/v2/REPLACE_APIKEY"],
  "bast": ["https://base-sepolia-rpc.publicnode.com", "https://base-sepolia.g.alchemy.com/v2/REPLACE_APIKEY"],
  "blst": ["https://sepolia.blast.io", "https://blast-sepolia.g.alchemy.com/v2/REPLACE_APIKEY"],
  "opst": ["https://sepolia.optimism.io", "https://opt-sepolia.g.alchemy.com/v2/REPLACE_APIKEY"],
  "unit": ["https://unichain-sepolia.drpc.org", "https://unichain-sepolia.g.alchemy.com/v2/REPLACE_APIKEY"]
}'
EXECUTOR_MAX_L3_GAS_PRICE="REPLACE_GAS_PRICE"
PRIVATE_KEY_LOCAL="REPLACE_PRIVATE_KEY"
ENABLED_NETWORKS="l2rn,arbitrum-sepolia,base-sepolia,optimism-sepolia,unichain-sepolia,blast-sepolia"
EOL

# Ganti placeholder di env file dengan nilai aktual
sudo sed -i "s|REPLACE_APIKEY|$APIKEY_ALCHEMY|g" "$ENV_FILE"
sudo sed -i "s|REPLACE_GAS_PRICE|$GAS_PRICE|g" "$ENV_FILE"
sudo sed -i "s|REPLACE_PRIVATE_KEY|$PRIVATE_KEY_LOCAL|g" "$ENV_FILE"

# Berikan hak akses ke user
sudo chown -R "$EXECUTOR_USER":"$EXECUTOR_USER" "$INSTALL_DIR"
sudo chmod 600 "$ENV_FILE"

# Buat systemd service
sudo tee $SERVICE_FILE > /dev/null <<EOL
[Unit]
Description=t3rn Executor Service
After=network.target

[Service]
User=$EXECUTOR_USER
WorkingDirectory=$INSTALL_DIR/executor/executor/bin
ExecStart=$INSTALL_DIR/executor/executor/bin/executor
Restart=always
RestartSec=10
Environment=ENVIRONMENT=testnet
Environment=LOG_LEVEL=debug
Environment=LOG_PRETTY=false
Environment=EXECUTOR_PROCESS_BIDS_ENABLED=true
Environment=EXECUTOR_PROCESS_ORDERS_ENABLED=true
Environment=EXECUTOR_PROCESS_CLAIMS_ENABLED=true
Environment=EXECUTOR
